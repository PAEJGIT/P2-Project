<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<link rel="stylesheet" href="../constants/styles.css" />
		<script src="../components/header/header.js"></script>
	</head>

	<body>
		<!-- Header with navigation -->
		<div id="header-container"></div>
		<div class="dashboard_content">
			<div class="dashboard_container">
				<!-- Left section -->
				<div class="dashboard_left_container">
					<div class="dashboard_left_container_section_recipes">
						<div class="dashboard_title_card">
							<span class="dashboard_title_card_text">Your Recipes</span>
						</div>

						<div id="dashboard_recipe_container" class="dashboard_recipe_container"></div>
					</div>

					<div class="dashboard_left_container_section_settings">
						<div class="dashboard_title_card">
							<div class="dashboard_title_card_text">Settings</div>
						</div>

						<div class="dashboard_settings_container">
							<div
								class="dashboard_setting_card"
								onclick="window.location.href = '/pages/choose_recipe.html'">
								<image
									class="dashboard_setting_card_icon"
									src="../../assets/icons/icon_settings_2.svg" />
								<span class="dashboard_setting_card_text">Change Recipes</span>
							</div>
							<div class="dashboard_setting_card" onclick="window.location.href = '/pages/stepper.html'">
								<image class="dashboard_setting_card_icon" src="../../assets/icons/icon_stepper.svg" />
								<span class="dashboard_setting_card_text">Repeat Stepper</span>
							</div>
							<div type="button" class="dashboard_setting_card" onclick="window.location.href = '/'">
								<image
									class="dashboard_setting_card_icon"
									src="../../assets/icons/icon_userDelete.svg" />
								<span class="dashboard_setting_card_text">Delete Account</span>
							</div>
						</div>
					</div>
				</div>

				<!-- Right section -->
				<div class="dashboard_right_container">
					<div class="dashboard_right_title_container">
						<span class="dashboard_right_title">
							<span class="dashboard_right_title_bold">Report</span> on this week
						</span>
						<span class="dashboard_right_description">From 23.05 to 30.05, 2024</span>
					</div>

					<div class="divider"></div>

					<!-- Circle Diagram -->
					<div class="dashboard_diagram_container">
						<div class="macronutrientChart">
							<img src="../assets/icons/icon_chart.svg" alt="Circle Diagram" />
						</div>
					</div>

					<div class="divider"></div>

					<!-- Stats -->
					<div class="dashboard_stats_row">
						<!-- BMR -->
						<div class="dashboard_stats_box">
							<div class="dashboard_stats_box_icon">
								<div class="dashboard_stats_box_icon_inner bg-grey"></div>
							</div>
							<div class="dashboard_stats_box_text">
								<span class="dashboard_stats_box_text_title">BMR</span>
								<span id="bmr_text" class="dashboard_stats_box_text_description"></span>
							</div>
						</div>
						<!-- BMI -->
						<div class="dashboard_stats_box">
							<div class="dashboard_stats_box_icon">
								<div class="dashboard_stats_box_icon_inner bg-grey"></div>
							</div>
							<div class="dashboard_stats_box_text">
								<span class="dashboard_stats_box_text_title">BMI</span>
								<span id="bmi_text" class="dashboard_stats_box_text_description"></span>
							</div>
						</div>
					</div>

					<div class="divider"></div>

					<!-- Stats -->
					<div class="dashboard_stats_container">
						<div class="dashboard_stats_column">
							<!-- Calories -->
							<div class="dashboard_stats_box">
								<div class="dashboard_stats_box_icon">
									<div class="dashboard_stats_box_icon_inner bg-red"></div>
								</div>
								<div class="dashboard_stats_box_text">
									<span class="dashboard_stats_box_text_title">Calories</span>
									<span id="calories_text" class="dashboard_stats_box_text_description"></span>
									<span
										id="calories_text_recipes"
										class="dashboard_stats_box_text_description"></span>
								</div>
							</div>

							<!-- Proteins -->
							<div class="dashboard_stats_box">
								<div class="dashboard_stats_box_icon">
									<div class="dashboard_stats_box_icon_inner bg-green"></div>
								</div>
								<div class="dashboard_stats_box_text">
									<span class="dashboard_stats_box_text_title">Proteins</span>
									<span id="proteins_text" class="dashboard_stats_box_text_description"></span>
									<span
										id="proteins_text_recipes"
										class="dashboard_stats_box_text_description"></span>
								</div>
							</div>
						</div>
						<div class="dashboard_stats_column">
							<!-- Carbohydrates -->
							<div class="dashboard_stats_box">
								<div class="dashboard_stats_box_icon">
									<div class="dashboard_stats_box_icon_inner bg-orange"></div>
								</div>
								<div class="dashboard_stats_box_text">
									<span class="dashboard_stats_box_text_title">Carbohydrates</span>
									<span id="carbohydrates_text" class="dashboard_stats_box_text_description"></span>
									<span
										id="carbohydrates_text_recipes"
										class="dashboard_stats_box_text_description"></span>
								</div>
							</div>

							<!-- Fats -->
							<div class="dashboard_stats_box">
								<div class="dashboard_stats_box_icon">
									<div class="dashboard_stats_box_icon_inner bg-blue"></div>
								</div>
								<div class="dashboard_stats_box_text">
									<span class="dashboard_stats_box_text_title">Fats</span>
									<span id="fats_text" class="dashboard_stats_box_text_description"></span>
									<span id="fats_text_recipes" class="dashboard_stats_box_text_description"></span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="wrapper">
			<span class="icon-close"><ion-icon name="close-outline"></ion-icon></span>
			<div class="form-box login">
				<h2>Login</h2>
				<form id="loginForm">
					<div class="input-box">
						<span class="icon"><ion-icon name="person"></ion-icon></span>
						<input type="text" name="username" required />
						<label>Username</label>
					</div>
					<div class="input-box">
						<span class="icon"><ion-icon name="lock-closed"></ion-icon></span>
						<input type="password" name="password" required />
						<label>Password</label>
					</div>
					<div class="remember-forgot">
						<label><input type="checkbox" /> Remember me</label>
						<a href="#">Forgot Password?</a>
					</div>
					<button type="submit" class="btn">Login</button>
					<div class="login-register">
						<p>
							Don't have an account?
							<a href="#" class="register-link" onclick=""> Register</a>
						</p>
					</div>
				</form>
			</div>

			<div class="form-box register">
				<h2>Register</h2>
				<form id="registerForm">
					<div class="input-box">
						<span class="icon"><ion-icon name="person"></ion-icon></span>
						<input type="text" name="usernameRegister" required />
						<label>Username</label>
					</div>
					<div class="input-box">
						<span class="icon"><ion-icon name="lock-closed"></ion-icon></span>
						<input type="password" name="passwordRegister" required />
						<label>Password</label>
					</div>
					<!-- <div class="remember-forgot">
				  <label><input type="checkbox" /> Remember me</label>
				  <a href="#">Forgot Password?</a>
				</div> -->
					<button type="submit" class="btn">Register</button>
					<div class="login-register">
						<p>
							Already have an account?
							<a href="#" class="login-link" onclick=""> Login</a>
						</p>
					</div>
				</form>
			</div>
		</div>

		<script>
			// Update user profile in accounts.json
			async function getProfile() {
				// Get current username from localStorage
				const username = localStorage.getItem('username');
				const response = await fetch('/getProfile', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ username }),
				});
				if (response.ok) {
					const data = response
						.json()
						.then((data) => {
							const userProfile = data.userProfile;
							return userProfile;
						})
						.catch((error) => {
							console.error('Error parsing JSON:', error);
						});
					return data;
				} else {
					console.error('Failed to update profile');
				}
			}
		</script>

		<script>
			// Get ID of item container
			const itemContainer = document.getElementById('dashboard_recipe_container');
			// Get ID of calories text
			const calories_text = document.getElementById('calories_text');
			const calories_text_recipes = document.getElementById('calories_text_recipes');
			// Get ID of proteins text
			const proteins_text = document.getElementById('proteins_text');
			const proteins_text_recipes = document.getElementById('proteins_text_recipes');
			// Get ID of carbohydrates text
			const carbohydrates_text = document.getElementById('carbohydrates_text');
			const carbohydrates_text_recipes = document.getElementById('carbohydrates_text_recipes');
			// Get ID of fats text
			const fats_text = document.getElementById('fats_text');
			const fats_text_recipes = document.getElementById('fats_text_recipes');
			// Get ID of bmr text
			const bmr_text = document.getElementById('bmr_text');
			// Get ID of bmi text
			const bmi_text = document.getElementById('bmi_text');

			// Fetch user from the server
			let globalValidRecipes = getProfile();
			globalValidRecipes.then((data) => {
				// Update dashboard with user data
				calories_text.textContent = data.TDEE + 'cal (expected)';
				proteins_text.textContent = data.proteins + 'g (expected)';
				carbohydrates_text.textContent = data.carbohydrates + 'g (expected)';
				fats_text.textContent = data.fats + 'g (expected)';
				bmr_text.textContent = Math.round(data.BMR) + 'cal';
				bmi_text.textContent = Math.round(data.BMI);

				// Get calories, proteins, carbohydrates and fats from each recipe
				const selectedRecipes = data.activeRecipes;
				const selectedRecipesNames = selectedRecipes.map((recipe) => recipe.name);

				const recipeStats = {
					calories: selectedRecipes.map((recipe) => recipe.calories * recipe.portions),
					proteins: selectedRecipes.map((recipe) => recipe.protein * recipe.portions),
					carbohydrates: selectedRecipes.map((recipe) => recipe.carb * recipe.portions),
					fats: selectedRecipes.map((recipe) => recipe.fat * recipe.portions),
				};
				calories_text_recipes.textContent = recipeStats.calories.reduce((a, b) => a + b, 0) + 'cal (from recipes)';
				proteins_text_recipes.textContent = recipeStats.proteins.reduce((a, b) => a + b, 0) + 'g (from recipes)';
				carbohydrates_text_recipes.textContent = recipeStats.carbohydrates.reduce((a, b) => a + b, 0) + 'g (from recipes)';
				fats_text_recipes.textContent = recipeStats.fats.reduce((a, b) => a + b, 0) + 'g (from recipes)';

				globalValidRecipes = data.activeRecipes;
				if (itemContainer) {
					globalValidRecipes.forEach((recipe, index) => {
						// Create an pop-over wrapper
						let popOverWrapper = document.createElement('div');
						popOverWrapper.className = 'popover__wrapper';
						// Create pop-over content
						let popOverContent = document.createElement('div');
						popOverContent.className = 'popover__content';
						// Set the pop-over content to the macros of the recipe
						const { calories, protein, carb, fat } = recipe;
						popOverContent.innerHTML = `<p>Calories: ${calories}</p> <p>Protein: ${protein}</p> <p>Carbs: ${carb}</p> <p>Fat: ${fat}</p>`;
						// Create a card for each recipe
						let card = document.createElement('div');
						card.className = 'dashboard_recipe_card';

						// Make card clickable and add event listener
						card.addEventListener('click', function () {
							// Change CSS of the card
							card.classList.toggle('dashboard_setting_card--active');
						});

						// Create an image for each recipe
						let image = document.createElement('img');
						image.onerror = function () {
							// Test if the image is available
							image.src = '../../assets/images/1_oatmeal_with_apple.jpg';
						};
						image.src = '../../' + recipe.image;
						image.className = 'card-img-top';
						card.appendChild(image);

						// Create a card body for each recipe
						let body = document.createElement('div');
						body.className = 'card-body';

						// Create a title for each recipe
						let title = document.createElement('h5');
						title.className = 'card-title';
						title.textContent = recipe.name;
						body.appendChild(title);

						// Create a one or multiple tags for each recipe
						const tagContainer = document.createElement('div');
						tagContainer.className = 'tag-container';
						const tags = recipe.tags;
						tags.forEach((tag) => {
							const tagElement = document.createElement('span');
							tagElement.className = 'badge badge-secondary';
							tagElement.textContent = tag;
							tagContainer.appendChild(tagElement);
						});
						body.appendChild(tagContainer);

						// Create a description for each recipe
						let descriptionContainer = document.createElement('div');
						let description = document.createElement('p');

						descriptionContainer.className = 'card-description-container';
						description.className = 'card-description';

						description.textContent = recipe.description;
						descriptionContainer.appendChild(description);
						body.appendChild(descriptionContainer);

						// Container to contain preparation time and ratings
						let preparationTimeRatingContainer = document.createElement('div');
						preparationTimeRatingContainer.className = 'preparation-time-rating-container';

						// Create a preparation time for each recipe
						let preparationTimeContainer = document.createElement('div');
						let preparationTimeIcon = document.createElement('i');
						let preparationTimeText = document.createElement('p');
						preparationTimeContainer.className = 'preparation-time-container';
						preparationTimeIcon.className = 'preparation-time-icon';
						preparationTimeIcon.style.backgroundImage = 'url(../../../assets/icons/icon_soup_filled.svg)';
						preparationTimeText.className = 'preparation-time';
						preparationTimeText.textContent = recipe.portions + ' portions';
						preparationTimeContainer.appendChild(preparationTimeIcon);
						preparationTimeContainer.appendChild(preparationTimeText);

						// Create ratings for each recipe
						let ratingContainer = document.createElement('div');
						let ratingAverage = recipe.ratings.averageRating; // 1-5
						let ratingNumberOf = recipe.ratings.numberOfRatings;
						let ratingIconDefaultPath = '../../assets/icons/icon_star_default.svg';
						let ratingIconFilledPath = '../../assets/icons/icon_star_filled.svg';
						ratingContainer.className = 'rating-container';
						for (let i = 0; i < 5; i++) {
							let ratingIcon = document.createElement('img');
							ratingIcon.src = i < ratingAverage ? ratingIconFilledPath : ratingIconDefaultPath;
							ratingIcon.className = 'rating-icon';
							ratingContainer.appendChild(ratingIcon);
						}

						preparationTimeRatingContainer.appendChild(preparationTimeContainer);
						preparationTimeRatingContainer.appendChild(ratingContainer);
						body.appendChild(preparationTimeRatingContainer);

						// Append the body to the card
						card.appendChild(body);
						// Append the card to the pop-over wrapper
						popOverWrapper.appendChild(card);
						itemContainer.appendChild(card);

						//* IGNORE
						// Append pop-over content to the pop-over wrapper
						//equipment
						//macroRatio
						//mealTypes
						//categories
						//allergens
						//ingredients
						//ratings
						//popOverWrapper.appendChild(popOverContent);
					});
				}
			});
		</script>
	</body>
</html>
