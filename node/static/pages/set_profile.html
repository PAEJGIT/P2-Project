<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
		<link rel="stylesheet" href="../constants/styles.css" />
		<script src="../utils/helpers/mealRecommendation.js"></script>
		<script src="../components/header.js"></script>
		<script src="../components/footer.js"></script>
	</head>

	<body>

		<div id="header-container"></div>

		<div id="grid_parent">
		
			<div id="step_bar">
				<div id="step_links">

					<div class="linkContainers">
						<ul> 
							<li>
								<img class="step_icons" src="https://static-00.iconduck.com/assets.00/full-screen-icon-256x256-z03tmnai.png">
								<a class="stepLinks" id="order/choose-mealplan"><span class="link_spans"></span>Vælg måltidsplan</a>
								<i></i>
							</li>
						</ul>
					</div>
	
					<div class="linkContainers" style="background-color: rgba(158, 158, 158, 0.384);">
						<ul> 
							<li>
								<img class="step_icons" style="filter: invert(0%) sepia(95%) saturate(21%) hue-rotate(2deg) brightness(92%) contrast(108%);" src="https://static-00.iconduck.com/assets.00/full-screen-icon-256x256-z03tmnai.png">
								<a class="stepLinks" id="order/set-profile" style="color: black;"><span class="link_spans"></span>Sundhedsprofil</a>
								<i></i>
							</li>
						</ul>
					</div>
	
					<div class="linkContainers">
						<ul> 
							<li>
								<img class="step_icons" src="https://static-00.iconduck.com/assets.00/full-screen-icon-256x256-z03tmnai.png">
								<a class="stepLinks" id="order/test"><span class="link_spans"></span>test</a>
								<i></i>
							</li>
						</ul>
					</div>

				</div>  

				<div id="order_box">
					<span>Prisoversigt:</span>
					<span>wrgrewhesthtes</span>
				</div>
			</div>

			<div id="step_header">
				<span id="step_title">Sundhedsprofil</span>

				<div id="step_buttons">
					<button id="button_back" onclick="previousPage(`http://localhost:3262/order/choose-mealplan`)">Tilbage</button>
					<button id="button_next">Næste</button>
				</div>
			</div>

			<div id="step_content">
				<div id="users">

				</div>

				<form class="profile_form" id="form1">
									
					<div> 
						<div class="inputText"> 
							<label for="select_sex" id="label_sex">Dit køn</label>
							<span>gkrsfog</span>
						</div>
						<select name="sex" id="select_sex" required>
							<option disabled selected value>— Vælg et køn —</option>
							<option value="male">Mand</option>
							<option value="female">Kvinde</option>
						</select>
					</div>

					<div> 
						<div class="inputText"> 
							<label for="age">Din alder</label>
							<span>gkrsfog</span>
						</div>
						<input type="number" id="age" min="10" max="100" name="age" step="1" required />
					</div>

					<div> 
						<div class="inputText"> 
							<label for="weight">Din kropsvægt</label>
							<span>gkrsfog</span>
						</div>
						<input type="number" id="weight" min="30" max="400" name="weight" step="1" required />
					</div>

					<div> 
						<div class="inputText"> 
							<label for="height">Din højde</label>
							<span>gkrsfog</span>
						</div>
						<input type="number" id="height" min="120" max="220" name="height" step="1" required />
					</div>

					<div> 
						<div class="inputText"> 
							<label for="select_activity" id="label_activity">Dit aktivitetsniveau</label>
							<span>gkrsfog</span>
						</div>
						<select name="activitylevel" id="select_activity" required>
							<option disabled selected value>— Vælg et aktivitetsniveau —</option>
							<option value="1">Lidt eller ingen aktivitet</option>
							<option value="2">Lidt aktiv (let motion 1-2 gange/uge) </option>
							<option value="3">Ret aktiv (moderat motion 2 dage/uge) </option>
							<option value="4">Aktiv (let/moderat motion 3-4 dage/uge) </option>
							<option value="5">Meget aktiv (Hård mortion 4-6 dage/uge) </option>		
						</select>
					</div>

					<div id="stepbuttons">
						<button id="backButtton">Tilbage</button>
						<button id="nextButton" onclick="updateCompletedSteps()">Næste</button>
					</div>
				</form>
			</div>
	</div>
	<div id="footer-container"></div>

		



	

		<script src="../components/allPages.js"></script>
		
		<script>
			

					
			/* dynamically renders a form for each profile */
			function profileRendering(numberOfPeople) {
				allProfiles = document.getElementById("users");

				
				for (let i = 0; i < numberOfPeople; i++) {
					profile = document.createElement("div");
					profileNumber = document.createElement("span");
					profileNumber.innerHTML = i + 1;
					profile.id = `profile${i + 1}`;

					allProfiles.append(profile);
					profile.append(profileNumber);

					if (i >= 1) {
						let form = document.getElementById("form1");
						newForm = form.cloneNode(true);
						newForm.class = `profile_form`;
						newForm.id = `form${i + 1}`;
						newForm.style.visibility = "hidden";
						content = document.getElementById("step_content");
						content.appendChild(newForm);
						addChildIds(i + 1);
					}
				}
			}
	

			function addChildIds(formNumber) {

				let childInputs = document.querySelectorAll(`#form${formNumber} input`);
				let childSelects = document.querySelectorAll(`#form${formNumber} select`);

				let firstFormInputs = document.querySelectorAll(`#form1 input`);
				let firstFormSelects = document.querySelectorAll(`#form1 select`);

					for (let i = 0; i < childInputs.length; i++) {
						childInputs[i].id = firstFormInputs[i].id + `${formNumber}`;
					}

					for (let i = 0; i < childSelects.length; i++) {
						childSelects[i].id = firstFormSelects[i].id + `${formNumber}`;
					}
			}


			mealPlan = localStorage.getItem("order/choose-mealplan");
			data = JSON.parse(mealPlan);

			profileRendering(data.peopleAmount);

			for (let i = 1; i <= data.peopleAmount; i++) {
				swapForms(`profile${i}`, `form${i}`);
			}

			/* makes it possible to swap between forms by clicking on the profile boxes */
			function swapForms(profile, form) {
				document.getElementById(profile).addEventListener("click", function () {
					for (let i = 1; i <= data.peopleAmount; i++) {
						let formVisibility = document.getElementById(`form${i}`);
						let userColor = document.getElementById(`profile${i}`)
						userColor.style.height = "100%";
						userColor.style.backgroundColor = "#a0abc0"
						formVisibility.style.visibility = "hidden";
					}

					userColor = document.getElementById(profile);
					userColor.style.backgroundColor = "#2d3648"
					userColor.style.height = "104%";

					formVisibility = document.getElementById(form);
					formVisibility.style.visibility = "visible";
				});
			}


    /* Saves all form data to localStorage when user navigates away from the page */

    window.addEventListener("beforeunload", () => {
		let allFormsData = [];
		
		for (let i = 1; i <= data.peopleAmount; i++) {
			let getEachForm = document.getElementById(`form${i}`)
			let formData = new FormData(getEachForm);
			let obj = Object.fromEntries(formData);
			allFormsData.push(obj);

        localStorage.setItem('order/set-profile', JSON.stringify(allFormsData));
	}
    });

	
	reloadPage();
	
	function reloadPage() {
		window.onload = function() {
    if (!window.location.hash) {
        window.location = window.location + '#loaded';
        window.location.reload();
    }
	}
	}

	
	
		/* checks if existing form data is available. if it is then assign the values to the input fields */
	if (localStorage.getItem('order/set-profile')) {
        const formData = JSON.parse(localStorage.getItem('order/set-profile'));
			document.getElementById("select_sex").value = formData[0].sex,
			document.getElementById("age").value = formData[0].age,
			document.getElementById("height").value = formData[0].height,
			document.getElementById("weight").value = formData[0].weight,
			document.getElementById("select_activity").value = formData[0].activitylevel
	
			for (let i = 2, k = 1; i <= data.peopleAmount; i++, k++) {
			document.getElementById(`select_sex${i}`).value = formData[`${k}`].sex,
			document.getElementById(`age${i}`).value = formData[`${k}`].age,
			document.getElementById(`height${i}`).value = formData[`${k}`].height,
			document.getElementById(`weight${i}`).value = formData[`${k}`].weight,
			document.getElementById(`select_activity${i}`).value = formData[`${k}`].activitylevel
			}
    }
	
				
	
	

	function previousPage(previousPage) {
		location.assign(previousPage);
	}

	/*
    function goForward() {
        let input = document.getElementsByClassName("formInput")

        for (let i = 0; i < input.length; i++) {
            if (!input[i].value) {
                window.alert("Please fill out the form");
                return;
            }
        }
        window.history.forward();
    }
	*/
	
	document.addEventListener("DOMContentLoaded", function () {
				const headerContainer = document.getElementById("header-container");
				headerContainer.innerHTML = Header();
			});
			document.addEventListener("DOMContentLoaded", function () {
				const headerContainer = document.getElementById("footer-container");
				headerContainer.innerHTML = Footer();
			});
	
		</script>
	</body>
</html>
