<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
		<link rel="stylesheet" href="../constants/styles.css" />
		<script src="../utils/helpers/mealRecommendation.js"></script>
	</head>

	<body>
		<div id="grid_parent">
			<div id="header">
				<a href="#"><img id="logo" src=https://www.iconpacks.net/icons/1/free-restaurant-icon-952-thumb.png></a>

				<nav class="nav_bar">
					<ul>
						<li>
							<img class="nav_icons" src="https://static-00.iconduck.com/assets.00/full-screen-icon-256x256-z03tmnai.png" />
							<a class="endpoints" href="#">Planlæg Måltid</a>
						</li>
						<li>
							<img class="nav_icons" src="https://static-00.iconduck.com/assets.00/full-screen-icon-256x256-z03tmnai.png" />
							<a class="endpoints" href="#">Alle Opskrifter</a>
						</li>
						<li>
							<img class="nav_icons" src="https://static-00.iconduck.com/assets.00/full-screen-icon-256x256-z03tmnai.png" />
							<a class="endpoints" href="#">Alle Ingredienser </a>
						</li>
						<li>
							<img class="nav_icons" src="https://static-00.iconduck.com/assets.00/full-screen-icon-256x256-z03tmnai.png" />
							<a class="endpoints" id="kosttilskud" href="#">Kosttilskud</a>
						</li>
					</ul>
				</nav>

				<div id="nav_buttons">
					<button id="log_in_button" onclick="location.href='https://google.com'" type="button">Log ind</button>
					<button id="sign_in_button" onclick="location.href='https://google.com'" type="button">Opret bruger</button>
				</div>
			</div>

			<div id="step_bar">
				<div id="step_links">
					<div class="linkContainers">
						<ul> 
							<li>
								<img class="step_icons" src="https://static-00.iconduck.com/assets.00/full-screen-icon-256x256-z03tmnai.png">
								<a class="stepLinks" id="order/choose-mealplan"><span class="link_spans"></span>Vælg måltidsplan</a>
								<i></i>
							</li>
						</ul>
					</div>
	
					<div class="linkContainers" style="background-color: rgba(158, 158, 158, 0.384);">
						<ul> 
							<li>
								<img class="step_icons" style="filter: invert(0%) sepia(95%) saturate(21%) hue-rotate(2deg) brightness(92%) contrast(108%);" src="https://static-00.iconduck.com/assets.00/full-screen-icon-256x256-z03tmnai.png">
								<a class="stepLinks" id="order/set-profile" style="color: black;"><span class="link_spans"></span>Sundhedsprofil</a>
								<i></i>
							</li>
						</ul>
					</div>
	
					<div class="linkContainers">
						<ul> 
							<li>
								<img class="step_icons" src="https://static-00.iconduck.com/assets.00/full-screen-icon-256x256-z03tmnai.png">
								<a class="stepLinks" id="order/test"><span class="link_spans"></span>test</a>
								<i></i>
							</li>
						</ul>
					</div>
				</div>  

				<div id="order_box">
					<span>Prisoversigt:</span>
					<span>wrgrewhesthtes</span>
				</div>
			</div>

			<div id="step_header">
				<span id="step_title">Sundhedsprofil</span>

				<div id="step_buttons">
					<button id="button_back" onclick="window.location.href = step1Page;">Tilbage</button>
					<button id="button_next">Næste</button>
				</div>
			</div>

			<div id="step_content">
				<div id="users">

				</div>

				<form class="profile_form" id="form1">
					<div>
						<label>Navn</label>
						<input type="text" id="name" name="name" required />
					</div>

					<div>
						<label for="select_sex" id="label_sex">Dit køn</label>
						<select name="sex" id="select_sex" required>
							<option disabled selected value>— Vælg et køn —</option>
							<option value="male">Mand</option>
							<option value="female">Kvinde</option>
						</select>
					</div>

					<div>
						<label for="age">Din alder</label>
						<input type="number" id="age" min="10" max="100" name="age" step="1" required />
					</div>

					<div>
						<label for="height">Din højde</label>
						<input type="number" id="height" min="120" max="220" name="height" step="1" required />
					</div>

					<div>
						<label for="weight">Din kropsvægt</label>
						<input type="number" id="weight" min="30" max="400" name="weight" step="1" required />
					</div>

					<div>
						<label for="select_allergies" id="label_allergies">Har du allergi(er)?</label>
						<select name="allergies" id="select_allergies">
							<option disabled selected value>— Nej, jeg har ingen allergi(er) —</option>
							<option value="lactoseintolerance">Laktoseintolerance</option>
							<option value="nutsallergic">Nøddeallergi</option>
							<option value="eggsallergic">Æggeallergi</option>
						</select>
					</div>

					<div>
						<label for="select_healthgoal" id="label_healthgoal">Hvad er dit sundhedsmål?</label>
						<select name="healthgoal" id="select_healthgoal" required>
							<option disabled selected value>— Vælg en fra listen —</option>
							<option value="weightloss">Vægttab</option>
							<option value="weightgain">Vægtøgning</option>
							<option value="maintaince">Generel Sundhed</option>
							<option value="musclegain">Muskeløgning</option>
						</select>
					</div>

					<input id="profileSubmit" type="submit" onclick="updateCompletedSteps()"/>
				</form>

				<div id="meal_plan">
					<div>
						<div id="meal_plan_title"></div>
						<div id="meal_plan_stats"></div>
					</div>
					<div id="meal_plan_div">
						<div id="meal_plan_content"></div>
					</div>
				</div>
		</div>
		<div id="footer">
			<span id="copyright">© 2023-current — Aalborg Universitet. All rights reserved.</span>

			<footer>
				<a href="#" class="footer_links">Privacy Policy</a>
				<a href="#" class="footer_links">Terms & Conditions</a>
				<a href="#" class="footer_links">Cookie Policy</a>
				<a href="#" class="footer_links">Contact</a>
			</footer>
		</div>
		<script>
			/* Recieve values from input fields and store them in an object */
			const form = document.getElementById("form1");
			form.addEventListener("submit", function (event) {
				event.preventDefault();
				const name = document.getElementById("name").value;
				const sex = document.getElementById("select_sex").value;
				const age = document.getElementById("age").value;
				const height = document.getElementById("height").value;
				const weight = document.getElementById("weight").value;
				const allergies = document.getElementById("select_allergies").value;
				const healthgoal = document.getElementById("select_healthgoal").value;
				const profile = {
					name: name,
					sex: sex,
					age: age,
					height: height,
					weight: weight,
					allergies: allergies,
					healthgoal: healthgoal,
				};
				const response = fetch("../data/recipes.json")
					.then((response) => response.json())
					.then((data) => {
						/* Call the mealRecommendation function and pass the profile object as an argument */
						const result = mealRecommendation(data, height, weight, age, 1);
						console.log("Result: ", result);
						console.table(result);

						/* Append meals to <div id="meal_plan_content"> */
						const mealPlanTitle = document.getElementById("meal_plan_title");
						mealPlanTitle.innerHTML = `<h1>Din måltidsplan, ${name}</h1>`;
						let mealPlanStats = document.getElementById("meal_plan_stats");
						mealPlanStats.innerHTML = `<h4>Stats</h4>`;
						mealPlanStats.innerHTML = `
						<hr>
						<p>Antal kalorier: ${result["totals"].calories} kcal</p>
						<p>Antal proteiner: ${result["totals"].proteins} g</p>
						<p>Antal kulhydrater: ${result["totals"].carbs} g</p>
						<p>Antal fedt: ${result["totals"].fats} g</p>
						<hr>
						`;

						const mealPlanContent = document.getElementById("meal_plan_content");
						/* Create a div element for each meal and append it to the mealPlanContent */
						/* Each div element contains the name of the meal, the amount of calories, proteins, carbohydrates, and fats on multiple lines with an image */
						mealPlanContent.innerHTML = "";
						for (let i = 0; i < 3; i++) {
							let current = ""
							if (i == 0) {
								current = "breakfast"
							} else if (i == 1) {
								current = "lunch"
							} else if (i == 2) {
								current = "dinner"
							}
							const meal = document.createElement("div");
							meal.className = "meal";
							meal.innerHTML = `<img src="${result[current].image}" alt="${result[current].name}" />
							<h3>${result[current].name}</h3>
							<p>${result[current].calories} kcal</p>
							<p>${result[current].proteins} g protein</p>
							<p>${result[current].carbs} g kulhydrater</p>
							<p>${result[current].fats} g fedt</p>`;
							mealPlanContent.appendChild(meal);
						}

						/**
						 * 						const breakfast = document.createElement("div");
						breakfast.innerHTML = `Morgenmad: \n${result.breakfast.name} - ${result.breakfast.calories} kcal\nProteins: ${result.breakfast.proteins}\nCarbohydrates: ${result.breakfast.carbs}\nFats: ${result.breakfast.fats}`;
						mealPlanContent.appendChild(breakfast);

						const lunch = document.createElement("div");
						lunch.innerHTML = `Frokost: \n${result.lunch.name} - ${result.lunch.calories} kcal\nProteins: ${result.lunch.proteins}\nCarbohydrates: ${result.lunch.carbs}\nFats: ${result.lunch.fats}`;
						mealPlanContent.appendChild(lunch);

						const dinner = document.createElement("div");
						dinner.innerHTML = `Aftensmad: \n${result.dinner.name} - ${result.dinner.calories} kcal\nProteins: ${result.dinner.proteins}\nCarbohydrates: ${result.dinner.carbs}\nFats: ${result.dinner.fats}`;
						mealPlanContent.appendChild(dinner);*/

					})
					.catch((error) => console.error("Error loading the JSON:", error));


				/* Store the profile object in the local storage */
				/* localStorage.setItem("profile", JSON.stringify(profile)); */

				/* Redirect to the next page */
				/* window.location.href = "http://localhost:3000/static/pages/test.html"; */
			});
		</script>

		<script src="../components/allPages.js"></script>
		
		<script>
			

					
			/* dynamically renders a form for each profile */
			function profileRendering(numberOfPeople) {
				allProfiles = document.getElementById("users");

				for (let i = 0; i < numberOfPeople; i++) {
					profile = document.createElement("div");
					profileNumber = document.createElement("span");
					profileNumber.innerHTML = i + 1;
					profile.id = `profile${i + 1}`;

					allProfiles.append(profile);
					profile.append(profileNumber);

					if (i >= 1) {
						let form = document.getElementById("form1");
						newForm = form.cloneNode(true);
						newForm.class = `profile_form`;
						newForm.id = `form${i + 1}`;
						newForm.style.visibility = "hidden";
						content = document.getElementById("step_content");
						content.appendChild(newForm);
						addChildIds(i + 1);
					
					}
				}
			}

			function addChildIds(formNumber) {

				let childInputs = document.querySelectorAll(`#form${formNumber} input`);
				let childSelects = document.querySelectorAll(`#form${formNumber} select`);

				let firstFormInputs = document.querySelectorAll(`#form1 input`);
				let firstFormSelects = document.querySelectorAll(`#form1 select`);

					for (let i = 0; i < childInputs.length; i++) {
						childInputs[i].id = firstFormInputs[i].id + `${formNumber}`;
					}

					for (let i = 0; i < childSelects.length; i++) {
						childSelects[i].id = firstFormSelects[i].id + `${formNumber}`;
					}
			}


			mealPlan = localStorage.getItem("order/choose-mealplan");
			data = JSON.parse(mealPlan);

			profileRendering(data.peopleAmount);

			for (let i = 1; i <= data.peopleAmount; i++) {
				swapForms(`profile${i}`, `form${i}`);
			}

			/* makes it possible to swap between forms by clicking on the profile boxes */
			function swapForms(profile, form) {
				document.getElementById(profile).addEventListener("click", function () {
					for (let i = 1; i <= data.peopleAmount; i++) {
						let hide = document.getElementById(`form${i}`);
						hide.style.visibility = "hidden";
					}

					hide = document.getElementById(form);
					hide.style.visibility = "visible";
				});
			}


    /* Saves all form data to localStorage when user navigates away from the page */

    window.addEventListener("beforeunload", () => {
		let allFormsData = [];
		
		for (let i = 1; i <= data.peopleAmount; i++) {
			let getEachForm = document.getElementById(`form${i}`)
			let formData = new FormData(getEachForm);
			let obj = Object.fromEntries(formData);
			allFormsData.push(obj);

        localStorage.setItem('order/set-profile', JSON.stringify(allFormsData));
	}
    });

	window.addEventListener("DOMContentLoaded", () => {
		let allFormsData = [];
		
		for (let i = 1; i <= data.peopleAmount; i++) {
			let getEachForm = document.getElementById(`form${i}`)
			let formData = new FormData(getEachForm);
			let obj = Object.fromEntries(formData);
			allFormsData.push(obj);

        localStorage.setItem('order/set-profile', JSON.stringify(allFormsData));
	}
    });
		
		/* checks if existing form data is available. if it is then assign the values to the input fields */
	if (localStorage.getItem('order/set-profile')) {
        const formData = JSON.parse(localStorage.getItem('order/set-profile'));
			document.getElementById("name").value = formData[0].name,
			document.getElementById("select_sex").value = formData[0].sex,
			document.getElementById("age").value = formData[0].age,
			document.getElementById("height").value = formData[0].height,
			document.getElementById("weight").value = formData[0].weight,
			document.getElementById("select_allergies").value = formData[0].allergies,
			document.getElementById("select_healthgoal").value = formData[0].healthgoal

			for (let i = 2, k = 1; i <= data.peopleAmount; i++, k++) {
			document.getElementById(`name${i}`).value = formData[`${k}`].name,
			document.getElementById(`select_sex${i}`).value = formData[`${k}`].sex,
			document.getElementById(`age${i}`).value = formData[`${k}`].age,
			document.getElementById(`height${i}`).value = formData[`${k}`].height,
			document.getElementById(`weight${i}`).value = formData[`${k}`].weight,
			document.getElementById(`select_allergies${i}`).value = formData[`${k}`].allergies,
			document.getElementById(`select_healthgoal${i}`).value = formData[`${k}`].healthgoal
			}
    }
	
				
	
	let step1Page = "http://localhost:3262/order/choose-mealplan";

	/*
    function goForward() {
        let input = document.getElementsByClassName("formInput")

        for (let i = 0; i < input.length; i++) {
            if (!input[i].value) {
                window.alert("Please fill out the form");
                return;
            }
        }
        window.history.forward();
    }
	*/
	
		</script>
	</body>
</html>
